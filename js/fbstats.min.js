var user,threadGetLimit=100,msgGetLimit=502,cacheTime=86400,smooth=0,stacked=!0,steps=!0,visibleGraphs=[],anonymous=!1,plotcolors="#942727 #5DA5DA #FAA43A #60BD68 #F17CB0 #B2912F #B276B2 #DECF3F #F15854 #4D4D4D".split(" ");function Person(a){this.id=a.user_id||0;this.name="undefined"==typeof a.name?"Andere":a.name}
function Thread(a){this.count=parseInt(a.num_messages||0,10);this.people=[];this.messages=[];this.id=a.thread_id;for(var b=0;b<a.participants.length;b++){var d=new Person(a.participants[b]);d.id!=user.userID&&this.people.push(d)}}function threadName(a,b){return a==Statistics.maxThreadCount?"Other":anonymous?"Person "+a:$.map(b.people,function(a){return a.name||a.id}).join(", ").substring(0,50)}
function hexToRGBA(a,b){a=parseInt(a.substring(1),16);return"rgba("+[a>>16,a>>8&255,a&255,b].join()+")"}function getAll(a){a||(a=Statistics.threads.length);visibleGraphs=[];for(var b=0;b<a;b++)visibleGraphs.push(b);Statistics.graphMessages()}
function pushOther(){for(var a=Statistics.maxThreadCount+1;a<Statistics.threads.length;a++)Statistics.threads[Statistics.maxThreadCount].messages=Statistics.threads[Statistics.maxThreadCount].messages.concat(Statistics.threads[a].messages);Statistics.threads[Statistics.maxThreadCount].messages.sort(function(a,d){return a-d});getAll(Statistics.maxThreadCount+1)}function login(){FB.login(function(a){document.location.reload()},{scope:"read_mailbox"})}
function start(){$("<a/>",{class:"btn btn-lg btn-primary centered",html:'<span id=threadload>Gathering statistics</span> <img src=loader.gif alt="loading..">'}).appendTo("#threadcount");$("<a/>",{class:"btn btn-lg btn-primary centered",html:"Select a person on the left"}).appendTo("#threadtime");Statistics.load()?Statistics.graphThreads():Statistics.countThreads();$("#loginbutton").fadeOut()}
function init(a){var b=$("#loginbutton"),d=$("#logintext"),e=b.children("img");b.show();d.text("Logging in to Facebook");FB.init({appId:a,xfbml:!1,cookie:!0});FB.getLoginStatus(function(a){switch(a.status){case "connected":d.text("Checking permissions");FB.api("/me/permissions",function(b){b.data[0].read_mailbox?(user=a.authResponse,start()):(d.text("Could not access message data"),e.hide())});break;default:d.text("Login to Facebook"),e.hide(),b.click(login)}});$("#threadcount").parent().resizable();
$("#threadtime").parent().resizable()}function log(a){console.groupCollapsed(a.callee.name);for(var b in a)console.log(a[b]);console.trace();console.groupEnd()}FB.apireal=FB.api;FB.api=function(a,b){log(arguments);FB.apireal(a,localStorage.getObject("fb_info")||{},b)};FB.fql=function(a,b){log(arguments);FB.apireal($.extend({method:"fql.query",query:a},localStorage.getObject("fb_info")||{}),b)};Storage.prototype.setObject=function(a,b){this.setItem(a,JSON.stringify(b))};
Storage.prototype.getObject=function(a){return(a=this.getItem(a))&&JSON.parse(a)};
var Statistics={maxThreadCount:20,threads:[],reducedThreads:[],save:function(){localStorage.setItem("lastUpdate",Statistics.lastUpdate);0==Statistics.lastUpdate&&(Statistics.threads=[]);localStorage.setObject("threads",Statistics.threads)},load:function(){var a=localStorage.getItem("lastUpdate");if(!a||Date.now()-parseInt(a,10)>1E3*cacheTime)return!1;Statistics.threads=localStorage.getObject("threads");return!0},countThreads:function(a){a=a||0;FB.fql("select participants,num_messages,thread_id from unified_thread where folder='inbox' LIMIT "+
threadGetLimit+" OFFSET "+a,function(b){if($.isArray(b)){for(var d=0;d<b.length;d++)Statistics.threads.push(new Thread(b[d]));$("#threadload").text("Getting thread "+Statistics.threads.length);0==b.length?(Statistics.threads.sort(function(a,b){return b.count-a.count}),Statistics.lastUpdate=Date.now(),Statistics.graphThreads()):Statistics.countThreads(a+b.length)}else $("#threadload").text("Error "+b.error_code+": "+b.error_msg),console.log("Error: ",b)})},graphThreads:function(){Statistics.reducedThreads=
[];for(var a=new Thread({participants:[new Person({user_id:0,name:"Other"})]}),b=0;b<Statistics.threads.length;b++)b>=Statistics.maxThreadCount?a.count+=Statistics.threads[b].count:Statistics.reducedThreads.push(Statistics.threads[b]);Statistics.reducedThreads[Statistics.maxThreadCount]=a;$.plot("#threadcount",[$.map(Statistics.reducedThreads,function(a,b){return[[a.count,threadName(b,a)]]})],{series:{bars:{show:!0,align:"center",barWidth:0.6,horizontal:!0}},grid:{hoverable:!0,clickable:!0},yaxis:{mode:"categories",
transform:function(a){return-a},inverseTransform:function(a){return-a}},xaxis:{position:"top"}});$("#threadcount").unbind("plotclick");$("#threadcount").bind("plotclick",function(a,b,c){c&&(a=c.datapoint[1],a!=Statistics.maxThreadCount&&(b=visibleGraphs.indexOf(a),0>b?visibleGraphs.push(a):visibleGraphs.splice(b,1),Statistics.graphMessages()))})},messageTimestamps:function(a,b){b=b||0;var d=Statistics.threads[a];console.log("downloading timestamps from thread "+a+" with offset "+b);FB.fql("select timestamp from unified_message where thread_id='"+
d.id+"' LIMIT "+msgGetLimit+" OFFSET  "+b,function(e){if($.isArray(e)){for(var c=0;c<e.length;c++){var g=parseInt(e[c].timestamp,10);10729152E5<=g&&d.messages.push(g)}$("#msgload").text("Downloading timestamp "+d.messages.length+" / "+d.count);0==e.length?(d.messages.sort(),Statistics.lastUpdate=Date.now(),Statistics.graphMessages(d)):Statistics.messageTimestamps(a,b+e.length)}else $("#msgload").text("Error "+e.error_code+": "+e.error_msg),console.log("Error: ",e)})},graphMessages:function(){for(var a=
[],b=0;b<visibleGraphs.length;b++){var d=visibleGraphs[b],e=Statistics.threads[d];if(!e.messages||0==e.messages.length){console.log("error: messages not downloaded for thread "+visibleGraphs[b]+", downloading..");$("<a/>",{class:"btn btn-lg btn-primary centered",html:"<span id=msgload>Downloading thread</span> <img src=loader.gif>"}).appendTo("#threadtime");Statistics.messageTimestamps(visibleGraphs[b]);return}var c={},g=new Date(0),f=new Date(e.messages[0]);f.setHours(0);f.setMinutes(0);f.setSeconds(0);
f.setMilliseconds(0);f.setDate(f.getDate()-f.getDay());for(var k=0;k<e.messages.length;k++)(new Date(e.messages[k])).getTime()<f.getTime()?c[g.getTime()]++:(g=new Date(f),c[g.getTime()]=0,f.setDate(f.getDate()+7));g=[];for(f=0;f<smooth;f++){var k={},m=0,l=0,n=0,h;for(h in c)n=l,l=m,m=h,0!=l&&(k[l]=0==n?(c[l]+c[m])/3:(c[l]+c[m]+c[n])/3);k[m]=(c[m]+c[l])/3;c=k}for(h in c)g.push([h,c[h]]);a.push({label:threadName(d,e),data:g})}d=1E100;for(b=e=0;b<a.length;b++)c=a[b].data[0][0],h=a[b].data[a[b].data.length-
1][0],c<d&&(d=c),h>e&&(e=h);for(b=0;b<a.length;b++){for(c=a[b].data;c[0][0]>d;)c.unshift([parseInt(c[0][0],10)-504E6,0]);for(;c[c.length-1][0]<e;)c.push([parseInt(c[c.length-1][0],10)+504E6,0])}$("#threadtime").plot(a,{xaxis:{mode:"time"},yaxis:{inversetransform:function(a){return a*a},transform:function(a){return Math.sqrt(a)}},legend:{position:"nw"},series:{stack:stacked,shadowSize:0},lines:{show:!0,lineWidth:0,fillColor:{colors:[{opacity:stacked?1:0.65},{opacity:stacked?0.99:0.64}]},fill:!0,steps:steps},
colors:plotcolors})},exportToCSV:function(){for(var a="",b=0;b<Statistics.threads.length;b++)for(var d=Statistics.threads[b],e=threadName(b,d),c=0;c<d.messages.length;c++)a+=[e,(new Date(d.messages[c])).toISOString()].join(";")+"\n";window.open().document.body.innerText=a}};Date.prototype.getWeek=function(){var a=new Date(this.getFullYear(),0,1);return Math.ceil(((this-a)/864E5+a.getDay()+1)/7)};
$(function(){var a=$("#loginbutton");$("#logintext");a.children("img");a.hide();$("#appidform").submit(function(){event.preventDefault();init($("#appidinput").val());$(this).hide()});$(window).on("beforeunload",function(){Statistics.lastUpdate&&0<Statistics.threads.length&&Statistics.save()})});
