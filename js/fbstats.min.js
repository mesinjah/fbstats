try{var user={userID:"unknown"};MIN_THREAD_MSG_COUNT=20;var other=!0,threadGetLimit=100,msgGetLimit=502,cacheTime=86400,smooth=0,stacked=!0,steps=!0,visibleGraphs=[],anonymous=!1,grouping="weekly",plotcolors="#942727 #5DA5DA #FAA43A #60BD68 #F17CB0 #B2912F #B276B2 #DECF3F #F15854 #4D4D4D".split(" "),scales={linear:{},sqrt:{inversetransform:function(a){return a*a},transform:function(a){return Math.sqrt(a)}},log:{inversetransform:function(a){return Math.exp(a)-1},transform:function(a){return Math.log(a+
1)}}},scale=scales.linear,Person=function(a){this.id=a.user_id||0;this.name="undefined"==typeof a.name?"Andere":a.name},Thread=function(a){this.count=parseInt(a.num_messages||0,10);this.people=[];this.messages=[];this.id=a.thread_id;for(var b=0;b<a.participants.length;b++){var c=new Person(a.participants[b]);c.id!=user.userID&&this.people.push(c)}},threadName=function(a,b,c){c||(c=50);if(-1==a)return"Other";if(anonymous)return"Person "+a;a=$.map(b.people,function(a){return a.name||a.id}).join(", ");
return a.length>c-3?a.substring(0,c-1)+"\u2026":a},hexToRGBA=function(a,b){a=parseInt(a.substring(1),16);return"rgba("+[a>>16,a>>8&255,a&255,b].join()+")"},getAll=function(a,b){b||(b=0);a||(a=Statistics.threads.length);visibleGraphs=[];for(var c=b;c<a;c++)visibleGraphs.push(c);Statistics.graphMessages()},getAllVisible=function(){getAll(Statistics.maxThreadCount)},getAllInvisible=function(){getAll(null,Statistics.maxThreadCount)},login=function(){FB.login(function(a){a.authResponse?(user=a.authResponse,
checkPerms()):document.location.reload()},{scope:"read_mailbox"})},start=function(){$("<a/>",{"class":"btn btn-lg btn-primary centered",html:'<span id=threadload>Gathering statistics</span> <img src=loader.gif alt="loading..">'}).appendTo("#threadcount");$("<a/>",{class:"btn btn-lg btn-primary centered",html:"Select a person on the left",id:"rswait"}).appendTo("#threadtime");Statistics.load()?Statistics.graphThreads():Statistics.countThreads();$("#loginbutton").fadeOut()},init=function(a){var b=$("#loginbutton"),
c=$("#logintext"),e=b.children("img");b.show();c.text("Logging in to Facebook");FB.init({appId:a,xfbml:!1,cookie:!0});FB.getLoginStatus(function(a){switch(a.status){case "connected":c.text("Checking permissions");user=a.authResponse;checkPerms();break;default:c.text("Login to Facebook"),e.hide(),b.click(login)}});$("#threadcount").parent().resizable();$("#threadtime").parent().resizable()},checkPerms=function(){FB.api("/me/permissions",function(a){a.data[0].read_mailbox?start():(txt.text("Could not access message data"),
img.hide())})},log=function(a){console.groupCollapsed(a.callee.name);for(var b in a)console.log(a[b]);console.trace();console.groupEnd()},mapTimestampsToDays=function(a){var b={},c=new Date(0),e=new Date(a[0]);e.setHours(0);e.setMinutes(0);e.setSeconds(0);e.setMilliseconds(0);switch(grouping){case "weekly":e.setDate(e.getDate()-e.getDay());break;case "monthly":e.setDate(1)}for(var d=0;d<a.length;d++)(new Date(a[d])).getTime()<e.getTime()?b[c.getTime()]++:(c=new Date(e),b[c.getTime()]=0,e.addInterval(1));
a=[];for(c=0;c<smooth;c++){var e={},f=d=0,h=0,g;for(g in b)h=f,f=d,d=g,0!=f&&(e[f]=0==h?(b[f]+b[d])/3:(b[f]+b[d]+b[h])/3);e[d]=(b[d]+b[f])/3;b=e}for(g in b)a.push([g,b[g]]);return a};FB.fql=function(a,b){log(arguments);FB.api({method:"fql.query",query:a},b)};Storage.prototype.setObject=function(a,b){this.setItem(a,JSON.stringify(b))};Storage.prototype.getObject=function(a){return(a=this.getItem(a))&&JSON.parse(a)};var Statistics={maxThreadCount:20,threads:[],reducedThreads:[],save:function(){localStorage.setItem("lastUpdate",
Statistics.lastUpdate);0==Statistics.lastUpdate&&(Statistics.threads=[]);localStorage.setObject("threads",Statistics.threads)},load:function(){var a=localStorage.getItem("lastUpdate");if(!a||Date.now()-parseInt(a,10)>1E3*cacheTime)return!1;Statistics.threads=localStorage.getObject("threads");return!0},countThreads:function(a){a=a||0;FB.fql("select participants,num_messages,thread_id from unified_thread where folder='inbox' LIMIT "+threadGetLimit+" OFFSET "+a,function(b){if($.isArray(b)){for(var c=
0;c<b.length;c++)b[c].num_messages<MIN_THREAD_MSG_COUNT||Statistics.threads.push(new Thread(b[c]));$("#threadload").text("Getting thread "+Statistics.threads.length);0==b.length?(Statistics.threads.sort(function(a,c){return c.count-a.count}),Statistics.lastUpdate=Date.now(),Statistics.graphThreads()):Statistics.countThreads(a+b.length)}else $("#threadload").text("Error "+b.error_code+": "+b.error_msg),console.log("Error: ",b)})},graphThreads:function(){Statistics.reducedThreads=[];for(var a=0,b=0;b<
Statistics.threads.length;b++)b>=Statistics.maxThreadCount?a+=Statistics.threads[b].count:Statistics.reducedThreads.push(Statistics.threads[b]);b=[$.map(Statistics.reducedThreads,function(a,b){return[[a.count,threadName(b,a)]]})];b[0].push([a,"Other"]);$.plot("#threadcount",b,{series:{bars:{show:!0,align:"center",barWidth:0.6,horizontal:!0}},grid:{hoverable:!0,clickable:!0},yaxis:{mode:"categories",transform:function(a){return-a},inverseTransform:function(a){return-a}},xaxis:{position:"top"}});$("#threadcount").unbind("plotclick");
$("#threadcount").bind("plotclick",function(a,b,d){d&&(a=d.datapoint[1],a!=Statistics.maxThreadCount&&(b=visibleGraphs.indexOf(a),0>b?visibleGraphs.push(a):visibleGraphs.splice(b,1),Statistics.graphMessages()))})},messageTimestamps:function(a,b){b=b||0;var c=Statistics.threads[a];FB.fql("select timestamp from unified_message where thread_id='"+c.id+"' LIMIT "+msgGetLimit+" OFFSET  "+b,function(e){if($.isArray(e)){for(var d=0;d<e.length;d++){var f=parseInt(e[d].timestamp,10);10729152E5<=f&&c.messages.push(f)}$("#msgload").text("Downloading timestamp "+
c.messages.length+" / "+c.count+" from thread "+a+" ("+threadName(a,c,20)+")");0==e.length?(c.messages.sort(),Statistics.lastUpdate=Date.now(),Statistics.graphMessages(c)):Statistics.messageTimestamps(a,b+e.length)}else $("#msgload").text("Error "+e.error_code+": "+e.error_msg),console.log("Error: ",e)})},graphMessages:function(){0<visibleGraphs.length&&$("#rswait").hide();for(var a=[],b=[],c=0;c<Statistics.threads.length;c++){var e=-1!=visibleGraphs.indexOf(c),d=Statistics.threads[c];if(e&&(!d.messages||
0==d.messages.length)){console.log("warn: messages not downloaded for thread "+c+", downloading..");0==$("#msgload").length&&$("<a/>",{class:"btn btn-lg btn-primary centered",html:"<span id=msgload>Downloading thread</span> <img src=loader.gif>"}).appendTo("#threadtime");Statistics.messageTimestamps(c);return}e?a.push({label:threadName(c,d),data:mapTimestampsToDays(d.messages)}):other&&(b=b.concat(d.messages))}other&&(b.sort(function(a,b){return a-b}),0<b.length&&a.push({label:"Other",data:mapTimestampsToDays(b)}));
b=1E100;for(c=e=0;c<a.length;c++){var d=a[c].data[0][0],f=a[c].data[a[c].data.length-1][0];d<b&&(b=d);f>e&&(e=f)}for(c=0;c<a.length;c++){for(d=a[c].data;d[0][0]>b;)f=new Date(parseInt(d[0][0],10)),f.addInterval(-1),d.unshift([f.getTime(),0]);for(;d[d.length-1][0]<e;)f=new Date(parseInt(d[d.length-1][0],10)),f.addInterval(1),d.push([f.getTime(),0])}$("#threadtime").plot(a,{xaxis:{mode:"time"},yaxis:scale,legend:{position:"nw"},series:{stack:stacked,shadowSize:0},lines:{show:!0,lineWidth:0,fillColor:{colors:[{opacity:stacked?
1:0.65},{opacity:stacked?0.99:0.64}]},fill:!0,steps:steps},colors:plotcolors})},exportToCSV:function(){for(var a="",b=0;b<Statistics.threads.length;b++)for(var c=Statistics.threads[b],e=threadName(b,c),d=0;d<c.messages.length;d++)a+=[e,(new Date(c.messages[d])).toISOString()].join(";")+"\n";window.open().document.body.innerText=a}};Date.prototype.getWeek=function(){var a=new Date(this.getFullYear(),0,1);return Math.ceil(((this-a)/864E5+a.getDay()+1)/7)};Date.prototype.addInterval=function(a){"monthly"==
grouping?this.setMonth(this.getMonth()+a):"weekly"==grouping?this.setDate(this.getDate()+7*a):this.setDate(this.getDate()+a)};$(function(){var a=$("#loginbutton");$("#logintext");a.children("img");a.hide();$("#appidform").submit(function(){try{event.preventDefault(),init($("#appidinput").val()),$(this).hide()}catch(a){throw $(".errormessage").append(a).fadeIn(),a;}});var a=$("#scaleselect").change(function(){scale=scales[$(this).val()];Statistics.graphThreads();Statistics.graphMessages()}),b;for(b in scales)$("<option/>").text(b).appendTo(a);
$("#groupingselect").change(function(){grouping=$(this).val();Statistics.graphThreads();Statistics.graphMessages()});$("#threadcountinput").change(function(){var a=$(this).val()||15;3>a&&(a=3);50<a&&(a=50);$(this).val(a);Statistics.maxThreadCount=a;Statistics.graphThreads()});$(window).on("beforeunload",function(){Statistics.lastUpdate&&0<Statistics.threads.length&&Statistics.save()})})}catch(e$$15){throw $(".errormessage").append(e$$15).fadeIn(),e$$15;}
"undefined"!=typeof console&&(console.olog="undefined"!=typeof console.log?console.log:function(){});console.log=function(a){console.olog(a);$("#debugDiv").append("<p>"+a+"</p>")};console.error=console.debug=console.info=console.log;
